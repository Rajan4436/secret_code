

<section class="cover container">
  <div class="cover-caption">
    <div class="row">
        <div class="col-sm-8 offset-sm-2">
          <h2 class="text-center">Sign up</h2>
            <div class="info-form">                                            
              <%= form_for(resource, as: resource_name, url: registration_path(resource_name), class: "form-inline justify-content-center") do |f| %>
                <%= devise_error_messages! %>

                <div class="form-group">
                  <%= f.text_field :first_name, autofocus: true, class: "form-control", placeholder: "First Name", required: :true %>
                </div>

                <div class="form-group">
                  <%= f.text_field :last_name, class: "form-control", placeholder: "Last Name", required: :true %>
                </div>


                <div class="form-group">
                  <%= f.email_field :email, class: "form-control", placeholder: "Email", required: :true, id: "email" %>
                </div>
                
                <div class="form-group">
                  <%= label_tag :secret_code, "Secret Code (generated by admin)" %>
                  <%= button_tag "Send Code to above email", class: "btn btn-sm btn-info", id: "secret_code"  %>
                  <span class="lds-dual-ring"></span>
                  <div id="code-data" class="text-danger"></div>
                  <%= text_field_tag :secret_code, nil, placeholder:"Enter the secret code received in email", id: "secret_code_field", class: "form-control" %>
                </div>

                <div class="form-group">
                  <% if @minimum_password_length %>
                  <em>(<%= @minimum_password_length %> characters minimum)</em>
                  <% end %><br />
                  <%= f.password_field :password, class: "form-control", autofocus: "off", placeholder: "Enter Password", required: :true %>
                </div>

                <div class="form-group">
                  <%= f.password_field :password_confirmation, class: "form-control", autofocus: "off", placeholder: "Password Confirm", required: :true %>
                </div>

                <div class="actions">
                  <%= f.submit "Sign up", class: "btn btn-primary" %>
                </div>
              <% end %>
            </div>
            <br>
            <%= render "devise/shared/links" %>
        </div>
    </div>
  </div>
</section>

<script type="text/javascript">
  $(function(){
    $(".info-form").on('click', '#secret_code', function(event) {
      if ($("#email").val() == '') {
        alert("Please enter email first");
        return false;
      }
      $(".lds-dual-ring").show();
      $("#secret_code").hide();
      $.ajax({
        url: '/deliver_code',
        type: 'POST',
        data: { email: $("#email").val() }
      })
      .done(function(res) {
        console.log(res);
        if (res.status) {
          // $("#secret_code_field").show();
          $(".lds-dual-ring").hide().after('<span style="font-size: 36px; color: green;">&#10004;</span>');
          $("#code-data").removeClass('text-danger').addClass('text-primary').html('Code Sent, Check your email and enter that code below');
        }else{
          console.log(res);
          $(".lds-dual-ring").hide();
          $("#secret_code").show();
          if (res.message == "stack empty") {
            $("#code-data").html('Admin need to generate secret codes before first sign up. Create admin user using console and navigate to <a href="/secrets">Secrets</a> page to generate some codes');
          }else if(res.message == "not available"){
            $("#code-data").html('Codes exhausted. As Admin please navigate to Secrets page to generate some more codes.');
          }else if(res.message == "invalid"){
            $("#code-data").html("Enter Valid Email");
          }
        }
      })
      .fail(function(err) {
        console.log(err);
      })
      .always(function() {
        console.log("complete");
      });
      return false;
    });
  });
</script>